apiVersion: batch/v1
kind: CronJob
metadata:
  name: pr-sync
  namespace: azuredocs-app
  labels:
    app: pr-sync
    component: scheduler
spec:
  # Run every 15 minutes
  schedule: "*/15 * * * *"
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 1800  # Auto-delete 30 min after completion
      template:
        metadata:
          labels:
            app: pr-sync
            component: scheduler
            azure.workload.identity/use: "true"
        spec:
          priorityClassName: worker-low-priority
          serviceAccountName: azuredocs-app-sa
          restartPolicy: Never
          containers:
          - name: pr-sync
            image: seanmckdemo.azurecr.io/queue-worker
            imagePullPolicy: Always
            command: ["python", "/app/worker/tasks/pr_sync.py"]
            env:
            - name: PYTHONPATH
              value: "/app"
            - name: GITHUB_SYNC_TOKEN
              valueFrom:
                secretKeyRef:
                  name: azuredocs-secrets
                  key: GITHUB_SYNC_TOKEN
            envFrom:
            - secretRef:
                name: sc-azuredocsdbconnection-secret
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
            volumeMounts:
            - name: secrets-store
              mountPath: "/mnt/secrets-store"
              readOnly: true
          volumes:
          - name: secrets-store
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "azuredocs-secrets"
  # Keep last 3 successful jobs and 3 failed jobs for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  # Don't run overlapping jobs
  concurrencyPolicy: Forbid
  suspend: false
