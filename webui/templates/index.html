<!DOCTYPE html>
<html>
<head>
    <title>Linux-first Docs for Azure - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let pollInterval = null;
        let pollCount = 0;
        const MAX_POLL_COUNT = 1000;
        const POLL_INTERVAL = 3000; // Reduced to 3 seconds for faster updates

        // Store the last progress data
        let lastProgressData = null;

        function renderProgress(data) {
            let prog = document.getElementById('progress');
            prog.style.display = 'block';

            let scannedCount = data.scanned || 0;
            let totalSnippets = data.total_snippets || 0;
            let flaggedCount = data.flagged || 0;
            let flaggedPages = data.flagged_pages || 0;
            let percentFlagged = data.percent_flagged || 0;

            prog.innerHTML = `
                <div class="progress-header">
                    <div class="progress-title">Scan in Progress</div>
                    <div class="progress-stage">${data.stage || 'Processing...'}</div>
                </div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value">${scannedCount}</div>
                        <div class="progress-stat-label">Pages Scanned</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">${totalSnippets}</div>
                        <div class="progress-stat-label">Snippets Found</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">${flaggedCount}</div>
                        <div class="progress-stat-label">Flagged Snippets</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value">${percentFlagged.toFixed(1)}%</div>
                        <div class="progress-stat-label">Bias Rate</div>
                    </div>
                </div>
                <div style="font-size:0.9em;color:#6b7280;">
                    Current: ${data.current_url || 'Processing...'}
                </div>
            `;
        }

        function renderFinalProgress() {
            if (lastProgressData) {
                let prog = document.getElementById('progress');
                prog.style.display = 'block';

                let scannedCount = lastProgressData.scanned || 0;
                let totalSnippets = lastProgressData.total_snippets || 0;
                let flaggedCount = lastProgressData.flagged || 0;
                let flaggedPages = lastProgressData.flagged_pages || 0;
                let percentFlagged = lastProgressData.percent_flagged || 0;

                prog.innerHTML = `
                    <div class="progress-header">
                        <div class="progress-title">Scan Complete</div>
                        <div class="progress-stage">Done</div>
                    </div>
                    <div class="progress-stats">
                        <div class="progress-stat">
                            <div class="progress-stat-value">${scannedCount}</div>
                            <div class="progress-stat-label">Pages Scanned</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value">${totalSnippets}</div>
                            <div class="progress-stat-label">Snippets Found</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value">${flaggedCount}</div>
                            <div class="progress-stat-label">Flagged Snippets</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value">${percentFlagged.toFixed(1)}%</div>
                            <div class="progress-stat-label">Bias Rate</div>
                        </div>
                    </div>
                    <div style="font-size:0.9em;color:#6b7280;">
                        Scan finished.
                    </div>
                `;
            }
        }

        function fetchFinalResults() {
            fetch('/progress')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    lastProgressData = data;
                    renderFinalProgress();
                })
                .catch(error => {
                    console.error('Error fetching final results:', error);
                });
        }

        function pollProgress() {
            if (pollCount >= MAX_POLL_COUNT) {
                console.warn('Max poll count reached, stopping polling');
                clearInterval(pollInterval);
                fetchFinalResults();
                return;
            }

            pollCount++;

            fetch('/progress')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    lastProgressData = data;
                    if (data.running) {
                        renderProgress(data);
                    } else {
                        clearInterval(pollInterval);
                        renderFinalProgress();
                        fetchFinalResults();
                        // window.location.reload(); // Removed to preserve styling
                    }
                })
                .catch(error => {
                    console.error('Error polling progress:', error);
                    if (pollCount > 10) {
                        clearInterval(pollInterval);
                        fetchFinalResults();
                    }
                });
        }

        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            pollCount = 0;
            pollInterval = setInterval(pollProgress, POLL_INTERVAL);
            // Initial poll
            pollProgress();
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        window.onload = function() {
            var scanRunning = "{{ 'true' if scan_status is sameas true else 'false' }}";
            if (scanRunning === "true") {
                startPolling();
            }
        };

        // Clean up on page unload
        window.onbeforeunload = function() {
            stopPolling();
        };
    </script>
</head>
<body>
<div class="container">
    <div class="left-nav">
        <h3>Azure Docs Sections</h3>
        <ul>
            {% for d in azure_dirs %}
                <li><a href="{{ d.html_url }}" target="_blank">{{ d.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <!-- Header -->
    <div class="header" style="margin-left:220px">
        <img class="tux-logo" src="/static/tux_reading.png" alt="Tux the Linux penguin reading a book with glasses">
        <div>
            <h1>Linux-first Docs for Azure</h1>
            <p class="subtitle">Dashboard for monitoring Azure documentation bias detection</p>
        </div>
    </div>

    <!-- Progress Bar (shown during scans) -->
    <div id="progress" style="margin-left:220px"></div>

    <!-- Dashboard Metrics -->
    <div class="dashboard-grid" style="margin-left:220px">
        {% if all_scans and all_scans|length > 0 %}
            {% set total_scans = all_scans|length %}
            {% set completed_scans = all_scans|selectattr('status', 'equalto', 'done')|list|length %}
            {% set running_scans = all_scans|selectattr('status', 'ne', 'done')|list|length %}
            {% set total_pages = all_scans|sum(attribute='scanned_count') %}
            {% set total_flagged = all_scans|sum(attribute='flagged_count') %}
            {% set avg_bias = (total_flagged / total_pages * 100) if total_pages > 0 else 0 %}
            
            <div class="metric-card">
                <div class="metric-title">Total Scans</div>
                <div class="metric-value">{{ total_scans }}</div>
                <div class="metric-subtitle">{{ completed_scans }} completed, {{ running_scans }} running</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Pages Analyzed</div>
                <div class="metric-value">{{ total_pages }}</div>
                <div class="metric-subtitle">Across all scans</div>
            </div>
            
            <div class="metric-card {% if avg_bias < 5 %}success{% elif avg_bias < 15 %}warning{% else %}danger{% endif %}">
                <div class="metric-title">Average Bias Rate</div>
                <div class="metric-value">{{ avg_bias|round(1) }}%</div>
                <div class="metric-subtitle">{{ total_flagged }} pages flagged</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Latest Scan</div>
                <div class="metric-value">{{ all_scans[0].percent_flagged }}%</div>
                <div class="metric-subtitle">{{ all_scans[0].scanned_count }} pages scanned</div>
            </div>
        {% else %}
            <div class="metric-card">
                <div class="metric-title">Total Scans</div>
                <div class="metric-value">0</div>
                <div class="metric-subtitle">No scans completed yet</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Pages Analyzed</div>
                <div class="metric-value">0</div>
                <div class="metric-subtitle">No data available</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Average Bias Rate</div>
                <div class="metric-value">0%</div>
                <div class="metric-subtitle">No data available</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Latest Scan</div>
                <div class="metric-value">-</div>
                <div class="metric-subtitle">No scans yet</div>
            </div>
        {% endif %}
    </div>

    <!-- Bias Rate Chart (moved up) -->
    <div style="margin:2em 0 2em 220px;">
        <h2>Bias Rate Over Time</h2>
        <canvas id="biasChart" width="800" height="300"></canvas>
        <script>
            // Chart.js expects valid JSON, so use the |tojson filter and wrap in safe
            const biasChartData = {{ bias_chart_data|tojson|safe }};
            const ctx = document.getElementById('biasChart').getContext('2d');
            // Dynamically set y-axis max based on data
            let yMax = 100;
            if (biasChartData.length > 0) {
                const maxVal = Math.max(...biasChartData.map(d => d.percent_flagged));
                yMax = Math.ceil(maxVal / 5) * 5 + 5; // round up to next 5 and add a little headroom
                if (yMax < 10) yMax = 10;
            }
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: biasChartData.map(d => d.date),
                    datasets: [{
                        label: '% Biased Pages',
                        data: biasChartData.map(d => d.percent_flagged),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231,76,60,0.1)',
                        fill: true,
                        tension: 0.2,
                        pointRadius: 3,
                        pointBackgroundColor: '#e74c3c',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            title: { display: true, text: '% Biased Pages' }
                        },
                        x: {
                            title: { display: true, text: 'Scan Date' }
                        }
                    }
                }
            });
        </script>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity" style="margin-left:220px">
        <h2>Recent Activity</h2>
        {% if all_scans and all_scans|length > 0 %}
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Started</th>
                        <th>Target URL</th>
                        <th>Pages</th>
                        <th>Flagged</th>
                        <th>Bias Rate</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for scan in all_scans[:10] %}
                    <tr>
                        <td>{{ scan.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                            {{ scan.url or 'Default path' }}
                        </td>
                        <td>{{ scan.scanned_count }}</td>
                        <td>{{ scan.flagged_count }}</td>
                        <td>
                            <span class="bias-percentage 
                                {% if scan.percent_flagged < 5 %}low
                                {% elif scan.percent_flagged < 15 %}medium
                                {% else %}high{% endif %}">
                                {{ scan.percent_flagged }}%
                            </span>
                        </td>
                        <td>
                            <span class="status-badge 
                                {% if scan.status == 'done' %}completed
                                {% elif scan.status == 'running' %}running
                                {% else %}failed{% endif %}">
                                {{ scan.status }}
                            </span>
                        </td>
                        <td>
                            <a href="/scan/{{ scan.id }}" class="view-link">View Details</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #6b7280; text-align: center; padding: 2em;">
                No scans completed yet. Scans are scheduled to run automatically.
            </p>
        {% endif %}
    </div>

    <!-- Recent Flagged Snippets -->
    {% if recent_flagged_snippets and recent_flagged_snippets|length > 0 %}
    <div class="recent-activity" style="margin-left:220px">
        <h2>Recent Issues Found</h2>
        <p style="color: #64748b; margin-bottom: 1.5em;">Latest Windows-biased content detected across all scans</p>
        
        {% for snippet in recent_flagged_snippets %}
        <div class="snippet-card">
            <div class="snippet-header">
                <div class="snippet-meta">
                    <div class="snippet-url">{{ snippet.page_url }}</div>
                    <div class="snippet-scan-info">
                        Scan #{{ snippet.scan_id }} ‚Ä¢ {{ snippet.scan_started.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                <div class="snippet-score">Windows Biased</div>
            </div>
            
            {% if snippet.context %}
            <div class="snippet-content">
                <div class="snippet-label">Context:</div>
                <div class="snippet-text">{{ snippet.context[:200] }}{% if snippet.context|length > 200 %}...{% endif %}</div>
            </div>
            {% endif %}
            
            {% if snippet.code %}
            <div class="snippet-content">
                <div class="snippet-label">Code Snippet:</div>
                <div class="snippet-text">{{ snippet.code[:300] }}{% if snippet.code|length > 300 %}...{% endif %}</div>
            </div>
            {% endif %}
            
            {% if snippet.llm_score %}
            <div class="snippet-content">
                <div class="snippet-label">Analysis:</div>
                <div class="analysis-content">
                    {% if snippet.llm_score.windows_biased %}
                        <div class="analysis-item">
                            <span class="analysis-icon">‚ö†Ô∏è</span>
                            <span class="analysis-text"><strong>Windows Bias Detected:</strong> This content appears to be Windows-specific or lacks Linux alternatives.</span>
                        </div>
                    {% endif %}
                    
                    {% if snippet.llm_score.bias_types %}
                        {% set bias_types = snippet.llm_score.bias_types %}
                        {% if bias_types.powershell_only %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üíª</span>
                                <span class="analysis-text"><strong>PowerShell Only:</strong> Uses PowerShell cmdlets or syntax specific to Windows.</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_paths %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üìÅ</span>
                                <span class="analysis-text"><strong>Windows Paths:</strong> Uses Windows-style paths with backslashes or C:\ drive references.</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_commands %}
                            <div class="analysis-item">
                                <span class="analysis-icon">‚ö°</span>
                                <span class="analysis-text"><strong>Windows Commands:</strong> Uses Windows-specific commands (dir, copy, del, etc.).</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_tools %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üîß</span>
                                <span class="analysis-text"><strong>Windows Tools:</strong> Uses Windows-only tools (regedit, msiexec, etc.).</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_specific_syntax %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üìù</span>
                                <span class="analysis-text"><strong>Windows Syntax:</strong> Uses Windows-specific syntax (backticks, etc.).</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_registry %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üóÑÔ∏è</span>
                                <span class="analysis-text"><strong>Windows Registry:</strong> References Windows registry keys or values.</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.windows_services %}
                            <div class="analysis-item">
                                <span class="analysis-icon">‚öôÔ∏è</span>
                                <span class="analysis-text"><strong>Windows Services:</strong> Uses Windows service management commands.</span>
                            </div>
                        {% endif %}
                        
                        {% if bias_types.missing_linux_example %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üêß</span>
                                <span class="analysis-text"><strong>Missing Linux Example:</strong> The documentation does not provide equivalent examples for Linux systems.</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- Fallback for old data format -->
                        {% if snippet.llm_score.missing_linux_example %}
                            <div class="analysis-item">
                                <span class="analysis-icon">üêß</span>
                                <span class="analysis-text"><strong>Missing Linux Example:</strong> The documentation does not provide equivalent examples for Linux systems.</span>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if snippet.llm_score.explanation %}
                        <div class="analysis-explanation">
                            <div class="explanation-label">Explanation:</div>
                            <div class="explanation-text">{{ snippet.llm_score.explanation[:150] }}{% if snippet.llm_score.explanation|length > 150 %}...{% endif %}</div>
                        </div>
                    {% endif %}
                    
                    {% if snippet.llm_score.suggested_linux_alternative %}
                        <div class="analysis-explanation">
                            <div class="explanation-label">Linux Alternative:</div>
                            <div class="explanation-text">{{ snippet.llm_score.suggested_linux_alternative[:100] }}{% if snippet.llm_score.suggested_linux_alternative|length > 100 %}...{% endif %}</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <div class="snippet-actions">
                <a href="/scan/{{ snippet.scan_id }}" class="view-link">View Full Scan Details</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Flagged Pages (per-page summary) -->
    {% if recent_flagged_pages and recent_flagged_pages|length > 0 %}
    <div class="recent-activity" style="margin-left:220px">
        <h2>Recent Biased Pages</h2>
        <p style="color: #64748b; margin-bottom: 1.5em;">Summary of bias detected per page (aggregated from all flagged snippets)</p>
        {% for page in recent_flagged_pages %}
        <div class="snippet-card">
            <div class="snippet-header">
                <div class="snippet-meta">
                    <div class="snippet-url">{{ page.url }}</div>
                    <div class="snippet-scan-info">
                        Scan #{{ page.scan_id }} ‚Ä¢ {{ page.scan_started.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                <div class="snippet-score">Page Bias Summary</div>
            </div>
            <div class="snippet-content">
                <ul style="margin:0 0 0 1em;">
                    {% if page.powershell_count > page.azcli_count %}
                        <li>Heavier use of <b>PowerShell</b> than az CLI/bash examples</li>
                    {% endif %}
                    {% if page.windows_count > page.linux_count %}
                        <li>Heavier use of <b>Windows</b> than Linux</li>
                    {% endif %}
                    {% if page.windows_first %}
                        <li><b>Windows</b> cited before Linux</li>
                    {% endif %}
                    {% if page.bias_types %}
                        {% for bias in page.bias_types %}
                            <li>Reference to bias type: <b>{{ bias.replace('_', ' ').title() }}</b></li>
                        {% endfor %}
                    {% endif %}
                    {% if page.windows_tools %}
                        <li>References to Windows-specific tools: {{ page.windows_tools|join(', ') }}</li>
                    {% endif %}
                </ul>
            </div>
            <div class="snippet-actions">
                <a href="/scan/{{ page.scan_id }}" class="view-link">View Full Scan Details</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
</body>
<style>
.left-nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 200px;
    height: 100vh;
    background: #f8fafc;
    border-right: 1px solid #e5e7eb;
    padding: 2em 1em 1em 1em;
    overflow-y: auto;
    z-index: 10;
}
.left-nav h3 {
    font-size: 1.1em;
    margin-bottom: 1em;
    color: #374151;
    font-weight: 600;
}
.left-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.left-nav li {
    margin-bottom: 0.7em;
}
.left-nav a {
    color: #2563eb;
    text-decoration: none;
    font-size: 1em;
    transition: color 0.2s;
}
.left-nav a:hover {
    color: #1e40af;
    text-decoration: underline;
}
@media (max-width: 900px) {
    .left-nav { display: none; }
    .header, .dashboard-grid, #progress, .recent-activity, .biasChart { margin-left: 0 !important; }
}
</style>
<!-- ...rest of file... -->
