<!DOCTYPE html>
<html>
<head>
    <title>Scan Details - Linux-first Docs for Azure</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/dashboard.css">
    <style>
        /* Dark theme overrides for scan details page */
        .container {
            max-width: 1200px;
            margin: 1em auto;
            padding: 0 1.5em;
        }

        .scan-details {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1.25em;
            box-shadow: 0 1px 8px rgba(0,0,0,0.2);
            margin-bottom: 1em;
            border: 1px solid var(--border-color);
        }
        .scan-details h2 {
            margin-top: 0;
            margin-bottom: 1em;
            color: var(--accent-yellow);
            font-size: 1.3em;
            font-family: var(--font-mono);
        }
        .scan-details p {
            font-size: 1em;
            color: var(--text-secondary);
        }
        .snippet-table {
            width: 100%;
            border-collapse: collapse;
        }
        .snippet-table th {
            text-align: left;
            padding: 1em 0.8em;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9em;
            font-family: var(--font-mono);
        }
        .snippet-table td {
            padding: 1em 0.8em;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            color: var(--text-secondary);
        }
        .snippet-table tr:hover {
            background: rgba(51, 65, 85, 0.3);
        }
        .scan-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5em;
            margin-bottom: 2em;
        }

        .summary-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5em;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .summary-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--accent-yellow);
            margin-bottom: 0.3em;
            font-family: var(--font-mono);
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.95em;
            font-weight: 500;
        }

        .page-section {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5em;
            margin-bottom: 1.25em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1em;
            padding-bottom: 0.75em;
            border-bottom: 1px solid var(--border-color);
        }

        .page-url {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            word-break: break-all;
        }

        .page-status {
            padding: 0.4em 0.8em;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }

        .snippet-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-radius: 12px;
            padding: 1.5em;
            margin-bottom: 1em;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .snippet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-yellow);
        }

        .snippet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1em;
        }

        .snippet-score {
            padding: 0.4em 0.8em;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 700;
            background: var(--accent-red-dim);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .snippet-content {
            margin-bottom: 1em;
        }

        .snippet-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5em;
            font-size: 0.95em;
            font-family: var(--font-mono);
        }

        .snippet-text {
            background: #0c0c0c;
            border-radius: 8px;
            padding: 1em;
            font-family: var(--font-mono);
            font-size: 0.9em;
            line-height: 1.5;
            color: var(--accent-green);
            border: 1px solid #1a1a1a;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .analysis-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5em;
            border: 1px solid var(--border-color);
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            gap: 0.8em;
            margin-bottom: 1em;
            padding: 0.8em;
            background: var(--accent-red-dim);
            border-radius: 8px;
            border-left: 4px solid var(--accent-red);
        }

        .analysis-icon {
            font-size: 1.2em;
            flex-shrink: 0;
            margin-top: 0.1em;
        }

        .analysis-text {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.95em;
        }

        .analysis-explanation {
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid var(--border-color);
        }

        .explanation-label {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.8em;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: var(--font-mono);
        }

        .explanation-text {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95em;
            background: var(--accent-blue-dim);
            padding: 1em;
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .no-flagged {
            text-align: center;
            padding: 3em;
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.3em;
            color: var(--accent-yellow);
            text-decoration: none;
            font-weight: 600;
            padding: 0.3em 0.6em;
            border-radius: 6px;
            background: var(--accent-yellow-dim);
            transition: all 0.3s ease;
            border: 1px solid rgba(250, 204, 21, 0.3);
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .back-link:hover {
            background: rgba(250, 204, 21, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(250, 204, 21, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1em;
            flex: 1;
        }

        .stop-scan-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5em;
            color: var(--accent-red);
            background: var(--accent-red-dim);
            text-decoration: none;
            font-weight: 600;
            padding: 0.6em 1.2em;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 1em;
        }

        .stop-scan-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }

        .stop-scan-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Mobile responsive adjustments for header */
        @media (max-width: 768px) {
            .container {
                margin: 0.5em auto;
                padding: 0 1em;
            }

            .back-link {
                margin-bottom: 0;
            }

            .header-content {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .back-link {
                font-size: 0.85em;
                padding: 0.25em 0.5em;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5em;
            }
        }

        /* Page Breadcrumb Styles */
        .page-breadcrumb {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Include Top Navigation -->
    {% include 'components/top_nav.html' %}
    
    <div class="container">
        <div class="page-breadcrumb">
            <a href="/" class="back-link">
                &#8592; Back to Dashboard
            </a>
        </div>
        <div id="scan-details-root">
        {% include "scan_details_partial.html" %}
        </div>
        <script>
        // Real-time scan progress with WebSocket and HTTP fallback
        const scanId = window.location.pathname.split("/").pop();
        let websocket = null;
        let fallbackTimer = null;
        let isConnected = false;
        
        // Progress tracking
        let currentProgress = {
            overall: 0,
            phase: '',
            phase_progress: 0,
            current_item: '',
            eta: null,
            activity_log: []
        };
        
        // Try WebSocket connection first
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/scan/${scanId}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                console.log('[WebSocket] Connected to scan progress updates');
                isConnected = true;
                clearInterval(fallbackTimer);
                updateConnectionStatus(true);
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleProgressUpdate(data);
            };
            
            websocket.onclose = function() {
                console.log('[WebSocket] Connection closed, falling back to HTTP polling');
                isConnected = false;
                updateConnectionStatus(false);
                startHttpFallback();
            };
            
            websocket.onerror = function(error) {
                console.log('[WebSocket] Error, falling back to HTTP polling:', error);
                isConnected = false;
                updateConnectionStatus(false);
                startHttpFallback();
            };
        }
        
        // HTTP polling fallback
        function startHttpFallback() {
            if (!isConnected) {
                pollScanDetails();
                fallbackTimer = setInterval(pollScanDetails, 3000);
            }
        }
        
        async function pollScanDetails() {
            // Always poll for now since WebSocket messages might not be working
            // TODO: Re-enable WebSocket-only mode once WebSocket broadcasting is fixed
            
            try {
                const resp = await fetch(`/scan/${scanId}/json`);
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('scan-details-root').innerHTML = data.html;
                    
                    // Also fetch detailed progress
                    const progressResp = await fetch(`/api/scan/${scanId}/progress`);
                    if (progressResp.ok) {
                        const progressData = await progressResp.json();
                        handleProgressUpdate({
                            type: 'progress_update',
                            ...progressData
                        });
                    }
                    
                    if (data.status === 'completed') {
                        clearInterval(fallbackTimer);
                    }
                }
            } catch (e) {
                console.error('[Polling] Error:', e);
            }
        }
        
        function handleProgressUpdate(data) {
            console.log('[Progress Update]', data);
            
            switch(data.type) {
                case 'connected':
                    addActivityLog('Connected to real-time updates');
                    break;
                    
                case 'initial_progress':
                    // Set current progress from initial state without animating
                    currentProgress.overall = data.overall_progress || 0;
                    currentProgress.phase = data.current_phase;
                    currentProgress.current_item = data.current_page_url;
                    
                    // Update progress bar to current state without animation
                    const progressBar = document.getElementById('overall-progress-bar');
                    if (progressBar && currentProgress.overall > 0) {
                        progressBar.dataset.initialProgress = currentProgress.overall;
                    }
                    addActivityLog('Connected to real-time updates');
                    updateProgressDisplay();
                    break;
                    
                case 'phase_start':
                    currentProgress.phase = data.phase;
                    addActivityLog(`Starting ${data.phase} phase: ${data.details?.description || ''}`);
                    updateProgressDisplay();
                    break;
                    
                case 'progress_update':
                    // Handle cancellation status in progress updates
                    if (data.cancellation_requested) {
                        currentProgress.phase = 'Cancelled';
                        currentProgress.current_item = data.cancellation_reason || 'Scan was stopped by admin';
                        addActivityLog(`üõë Scan cancelled: ${data.cancellation_reason || 'Manually stopped by admin'}`, 'error');
                        
                        // Hide the stop button if it's visible
                        const stopBtn = document.querySelector('.stop-scan-btn');
                        if (stopBtn) {
                            stopBtn.style.display = 'none';
                        }
                    } else {
                        currentProgress.overall = data.overall_progress || 0;
                        currentProgress.phase = data.phase;
                        currentProgress.phase_progress = data.progress_percentage || 0;
                        currentProgress.current_item = data.current_item;
                        currentProgress.eta = data.estimated_completion;
                        
                        if (data.current_item) {
                            addActivityLog(`Processing: ${data.current_item}`);
                        }
                    }
                    
                    updateProgressDisplay();
                    break;
                    
                case 'phase_complete':
                    addActivityLog(`Completed ${data.phase} phase`);
                    if (data.summary) {
                        addActivityLog(`Summary: ${JSON.stringify(data.summary)}`);
                    }
                    break;
                    
                case 'page_result':
                    if (data.has_bias) {
                        addActivityLog(`‚ö†Ô∏è Bias detected on: ${data.page_url}`);
                        // Could add live results here
                    }
                    break;
                    
                case 'error':
                    addActivityLog(`‚ùå Error: ${data.message}`, 'error');
                    break;
                    
                default:
                    // Handle scan completion (done, cancelled, error)
                    if (data.status === 'completed' || data.status === 'error' || data.status === 'cancelled') {
                        clearInterval(fallbackTimer);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000); // Give a moment to see the final status
                    }
                    break;
            }
        }
        
        function addActivityLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            currentProgress.activity_log.unshift({
                timestamp,
                message,
                type
            });
            
            // Keep only last 50 entries
            if (currentProgress.activity_log.length > 50) {
                currentProgress.activity_log = currentProgress.activity_log.slice(0, 50);
            }
            
            updateActivityDisplay();
        }
        
        function updateProgressDisplay() {
            // Update progress bar
            const progressBar = document.getElementById('overall-progress-bar');
            if (progressBar) {
                const initialProgress = parseFloat(progressBar.dataset.initialProgress) || 0;
                const newProgress = currentProgress.overall || 0;
                
                // Only update if there's a meaningful change and it's not going backwards
                if (newProgress >= initialProgress && Math.abs(newProgress - initialProgress) > 0.1) {
                    progressBar.style.width = `${newProgress}%`;
                    progressBar.textContent = `${Math.round(newProgress)}%`;
                }
            }
            
            // Update phase display
            const phaseDisplay = document.getElementById('current-phase-display');
            if (phaseDisplay) {
                phaseDisplay.textContent = currentProgress.phase || 'Starting...';
            }
            
            // Update current item
            const currentItemDisplay = document.getElementById('current-item-display');
            if (currentItemDisplay && currentProgress.current_item) {
                currentItemDisplay.textContent = currentProgress.current_item;
            }
            
            // Update ETA
            const etaDisplay = document.getElementById('eta-display');
            if (etaDisplay && currentProgress.eta) {
                const eta = new Date(currentProgress.eta);
                etaDisplay.textContent = `ETA: ${eta.toLocaleTimeString()}`;
            }
        }
        
        function updateActivityDisplay() {
            const activityFeed = document.getElementById('activity-feed');
            if (activityFeed) {
                activityFeed.innerHTML = currentProgress.activity_log
                    .slice(0, 10) // Show only last 10 items
                    .map(item => `
                        <div class="activity-item ${item.type}">
                            <span class="activity-time">${item.timestamp}</span>
                            <span class="activity-message">${item.message}</span>
                        </div>
                    `).join('');
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connection-status');
            if (statusIndicator) {
                statusIndicator.className = connected ? 'connected' : 'disconnected';
                statusIndicator.textContent = connected ? 'üü¢ Live' : 'üî¥ Polling';
            }
        }
        
        // Initialize connection when page loads
        window.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            // Also start HTTP polling as backup since WebSocket messages may not work
            startHttpFallback();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (fallbackTimer) {
                clearInterval(fallbackTimer);
            }
        });
        
        // Stop scan function
        async function stopScan(scanId) {
            if (!confirm('Are you sure you want to stop this scan? This action cannot be undone.')) {
                return;
            }
            
            const stopBtn = document.querySelector('.stop-scan-btn');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.textContent = '‚èπÔ∏è Stopping...';
            }
            
            try {
                const response = await fetch(`/admin/scan/${scanId}/stop`, {
                    method: 'POST',
                    credentials: 'include'  // Include cookies for session authentication
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert(result.message);
                    // Refresh the page to show updated scan status
                    window.location.reload();
                } else {
                    alert(`Failed to stop scan: ${result.message || 'Unknown error'}`);
                    if (stopBtn) {
                        stopBtn.disabled = false;
                        stopBtn.textContent = '‚èπÔ∏è Stop Scan';
                    }
                }
            } catch (error) {
                console.error('Error stopping scan:', error);
                alert('Error stopping scan. Please try again.');
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.textContent = '‚èπÔ∏è Stop Scan';
                }
            }
        }
        </script>
    </div>
</body>
</html>
